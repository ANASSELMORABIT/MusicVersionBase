@model PRJ_FINAL_MP09_MP03.Models.MusicViewModel
@{
    Layout = null;
}

@{
    ViewData["Title"] = "Dashboard Musical";
    
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Musical</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Estilo personalizado -->
    <link href="~/css/dashboard.css" rel="stylesheet" />
</head>
<body>


    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" asp-controller="Music" asp-action="Dashboard">üé∂ MusicApp</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" asp-controller="Music" asp-action="Trending">Trending</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" asp-controller="Music" asp-action="Recomendaciones">Recomendaciones</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" asp-controller="Music" asp-action="Playlist">Playlist</a>
        </li>

        <li class="nav-item"></li>
          <a class="nav-link" asp-controller="Music" asp-action="Lyrics">Lyrics</a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" asp-controller="Account" asp-action="Profile">Profile</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-danger" asp-controller="Account" asp-action="Logout">Sign Out</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <!-- Fondo y gradientes -->
  <div class="gradient-bg">
    <svg xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="goo">
          <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -8" result="goo" />
          <feBlend in="SourceGraphic" in2="goo" />
        </filter>
      </defs>
    </svg>
    <div class="gradients-container">
      <div class="g1"></div>
      <div class="g2"></div>
      <div class="g3"></div>
      <div class="g4"></div>
      <div class="g5"></div>
      <div class="interactive"></div>
    </div>
  </div>

  <!-- Tu contenido del Dashboard -->
  <div class="content-container">
    <form method="get" asp-controller="Music" asp-action="BuscarTrackId" class="container mt-4 d-flex justify-content-center">
        <input type="text" name="nombreCancion" class="form-control w-50 me-2" placeholder="Buscar canci√≥n por nombre..." required />
        <button type="submit" class="btn btn-success">Buscar</button>
    </form>

    <div id="downloadResult" class="text-center mt-4"> 
        
    </div>


    <h1 class="text-center mt-4">üéµ Recomendaciones Musicales</h1>

    @if (TempData["TrackId"] != null)
    {
        @* <script>
            const trackId = '@TempData["TrackId"]';

            
            getTrackUrlFromApi(trackId);
        </script> *@

         <div class="alert alert-success text-center mt-4">
            
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    getTrackUrlFromApi('@TempData["TrackId"]');
                });
            </script>
        </div>
    }
    else if (TempData["Error"] != null)
    {
        <div class="alert alert-danger text-center mt-4">
            @TempData["Error"]
        </div>
    }


    @if (Model.Recommendations != null && Model.Recommendations.Any())
    {
        <div class="container mt-4">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                @foreach (var rec in Model.Recommendations)
                {
                    var song = rec.recommended_song;
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <img src="@song.song_art_image_url" class="card-img-top" alt="Imagen de @song.title">
                            <div class="card-body">
                                <h5 class="card-title">@song.title</h5>
                                <p class="card-text"><strong>Artista:</strong> @song.artist_names</p>
                                <a href="@song.url" target="_blank" class="btn btn-primary">Ver en Genius</a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning text-center mt-5">
            No se encontraron recomendaciones musicales.
        </div>
    }
@* 
    <hr class="my-5"/>
    @{
        var selectedPeriod = Context.Request.Query["timePeriod"].FirstOrDefault() ?? "week";
    }

    <form method="get" asp-controller="Music" asp-action="Dashboard" class="text-center my-4">
        <label for="timePeriod">Filtrar por per√≠odo:</label>
        <select name="timePeriod" id="timePeriod" class="form-select d-inline-block w-auto mx-2">
            <option value="day" selected="@(selectedPeriod == "day")">D√≠a</option>
            <option value="week" selected="@(selectedPeriod == "week")">Semana</option>
            <option value="month" selected="@(selectedPeriod == "month")">Mes</option>
        </select>
        <button type="submit" class="btn btn-secondary">Actualizar</button>
    </form>

    <h2 class="text-center">üî• Canciones en Tendencia</h2>

    @if (Model.Trending != null && Model.Trending.Any())
    {
        <div class="container mt-4">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                @foreach (var item in Model.Trending)
                {
                    var song = item.item;
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <img src="@song.song_art_image_url" class="card-img-top" alt="Imagen de @song.title">
                            <div class="card-body">
                                <h5 class="card-title">@song.title</h5>
                                <p class="card-text"><strong>Artista:</strong> @song.artist_names</p>
                                <a href="@song.url" target="_blank" class="btn btn-warning">Ver en Genius</a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center mt-4">
            No se encontraron canciones en tendencia.
        </div>
    }


    <h2 class="text-center mt-5">üé§ Artistas en Tendencia</h2>

    @if (Model.TrendingArtists != null && Model.TrendingArtists.Any())
    {
        <div class="container mt-4">
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    @foreach (var item in Model.TrendingArtists)
                    {
                        var Artist = item.item;
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <img src="@Artist.image_url" class="card-img-top" alt="Imagen de @Artist.name">
                                <div class="card-body">
                                    <h5 class="card-title">@Artist.name</h5>
                                    <p class="card-text"><strong>Artista:</strong> @Artist.name</p>
                                    <a href="@Artist.url" target="_blank" class="btn btn-warning">Ver en Genius</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
        </div>

        
    }
    else
    {
        <div class="alert alert-info text-center mt-4">
            No se encontraron artistas en tendencia.
        </div>
    }


<h2 class="text-center mt-5">üìÄ √Ålbumes en Tendencia</h2>

@if (Model.TrendingAlbums != null && Model.TrendingAlbums.Any())
{
    <div class="container mt-4">
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    @foreach (var item in Model.TrendingAlbums)
                    {
                        var song = item.item;
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <img src="@song.cover_art_url" class="card-img-top" alt="Imagen de @song.full_title">
                                <div class="card-body">
                                    <h5 class="card-title">@song.full_title</h5>
                                    <p class="card-text"><strong>Artista:</strong> @song.primary_artist_names</p>
                                    <a href="@song.url" target="_blank" class="btn btn-warning">Ver en Genius</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
        </div>
    
}
else
{
    <div class="alert alert-info text-center mt-4">
        No se encontraron √°lbumes en tendencia.
    </div>
} *@


    
  </div> 


<script>
async function getTrackUrlFromApi(trackId) {
    const spotifyMp3ApiUrl = `https://spotify-music-mp3-downloader-api.p.rapidapi.com/download?link=https%3A%2F%2Fopen.spotify.com%2Ftrack%2F${trackId}`;
    const spotifyDataApiUrl = `https://spotify-data.p.rapidapi.com/tracks/?ids=${trackId}`;


    const mp3Options = {
        method: 'GET',
        headers: {
            'x-rapidapi-key': 'ef26a00f67msh88ef9454dd8eb45p183055jsndc546b76893b',
            'x-rapidapi-host': 'spotify-music-mp3-downloader-api.p.rapidapi.com'
        }
    };

    const dataOptions = {
        method: 'GET',
        headers: {
            'x-rapidapi-key': 'e021de509fmsh80d2026e169e54cp1f1c70jsnaa85f4037fb7',
            'x-rapidapi-host': 'spotify-data.p.rapidapi.com'
        }
    };

    const youtubeOptions = {
            method: 'GET',
            headers: {
                'x-rapidapi-key': '1eafb2f804mshbca184d703c45e8p14cfbejsn879e1a0dd073',
                'x-rapidapi-host': 'youtube138.p.rapidapi.com'
            }
    };

    const youtubeMp3Options = {
        method: 'GET',
        headers: {
            'x-rapidapi-key': '7e97041cc6msh18d9432dfea7095p1d16e1jsna77fb7101106',
            'x-rapidapi-host': 'youtube-mp36.p.rapidapi.com'
        }
    };
    try {
        // Obtener el MP3
        const mp3Response = await fetch(spotifyMp3ApiUrl, mp3Options);
        const mp3Result = await mp3Response.json();

        if (!mp3Result.success || !mp3Result.data?.medias?.length) {
            throw new Error("No se pudo obtener el MP3 desde Spotify.");
        }

        const media = mp3Result.data.medias[0];
        const mp3Url = media.url;
        const fallbackTitle = mp3Result.data.title;

        // Obtener los detalles de la canci√≥n
        const dataResponse = await fetch(spotifyDataApiUrl, dataOptions);
        const dataResult = await dataResponse.json();

        const track = dataResult.tracks?.[0];
        if (!track) {
            throw new Error("No se pudieron obtener los detalles de la canci√≥n.");
        }

        const title = track.name || fallbackTitle;
        const artists = track.artists.map(a => a.name).join(", ");
        const albumName = track.album.name;
        const imageUrl = track.album.images?.[0]?.url || "";
        const releaseDate = track.album.release_date;
        const popularity = track.popularity;

        const YoutubeVideoId = `https://youtube138.p.rapidapi.com/search/?q=${encodeURIComponent(title)}&hl=en&gl=ES`; 
        
        const youtubeResponse = await fetch(YoutubeVideoId, youtubeOptions);
        const youtubeResult = await youtubeResponse.json();
        const videoId = youtubeResult.contents?.[0]?.video?.videoId;

        const YoutubeMp3Url = `https://youtube-mp36.p.rapidapi.com/dl?id=${videoId}`;

        const youtubeResponseMp3 = await fetch(YoutubeMp3Url, youtubeMp3Options);
        const youtubeResultMp3 = await youtubeResponseMp3.json();
        const mp3UrlMp3 = youtubeResultMp3.link;
        // Mostrar card con los datos
        document.getElementById("downloadResult").innerHTML = `
            <div class="card mx-auto mt-4 shadow" style="max-width: 700px;">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${imageUrl}" class="img-fluid rounded-start" alt="Portada canci√≥n">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${title}</h5>
                            <p class="card-text"><strong>Artistas:</strong> ${artists}</p>
                            <p class="card-text"><strong>√Ålbum:</strong> ${albumName}</p>
                            <p class="card-text"><strong>Fecha de lanzamiento:</strong> ${releaseDate}</p>
                            <p class="card-text"><strong>Popularidad:</strong> ${popularity}</p>
                            <audio controls class="w-100 mt-2">
                                <source src="${mp3Url}" type="audio/mpeg">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                            <a href="${mp3UrlMp3}" download class="btn btn-primary mt-2">Descargar MP3</a>
                        </div>
                    </div>
                </div>
            </div>`;
    } catch (error) {
        document.getElementById("downloadResult").innerHTML = `
            <div class="alert alert-danger">
                ‚ùå Error al obtener datos: ${error.message}
            </div>`;
        console.error(error);
    }
}
</script>



</body>
</html>